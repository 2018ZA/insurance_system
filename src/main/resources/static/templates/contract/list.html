<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head('Договоры')"></head>
<body>
    <div th:replace="fragments/header :: header"></div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div th:replace="fragments/menu :: menu"></div>
            </div>
            
            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-file-contract"></i> Договоры страхования
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <a href="/contracts/new" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Новый договор
                        </a>
                    </div>
                </div>
                
                <!-- Уведомления -->
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check-circle"></i> [[${success}]]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                    <i class="fas fa-exclamation-circle"></i> [[${error}]]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <!-- Фильтры -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-filter"></i> Фильтры и поиск
                        </h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/contracts}" method="get" class="row g-3">
                            <div class="col-md-3">
                                <label for="contractNumber" class="form-label">Номер договора</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="contractNumber"
                                       name="contractNumber"
                                       th:value="${contractNumber}"
                                       placeholder="Введите номер">
                            </div>
                            
                            <div class="col-md-3">
                                <label for="typeCode" class="form-label">Тип страхования</label>
                                <select class="form-select" id="typeCode" name="typeCode">
                                    <option value="">Все типы</option>
                                    <option th:each="type : ${insuranceTypes}"
                                            th:value="${type.code}"
                                            th:text="${type.name}"
                                            th:selected="${typeCode == type.code}">
                                    </option>
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label for="statusCode" class="form-label">Статус</label>
                                <select class="form-select" id="statusCode" name="statusCode">
                                    <option value="">Все статусы</option>
                                    <option value="ACTIVE">Активен</option>
                                    <option value="EXPIRED">Истек</option>
                                    <option value="TERMINATED">Расторгнут</option>
                                    <option value="DRAFT">Черновик</option>
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label for="startDate" class="form-label">Дата начала</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="startDate"
                                       name="startDate"
                                       th:value="${startDate}">
                            </div>
                            
                            <div class="col-md-3">
                                <label for="endDate" class="form-label">Дата окончания</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="endDate"
                                       name="endDate"
                                       th:value="${endDate}">
                            </div>
                            
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Применить фильтры
                                    </button>
                                    <a href="/contracts" class="btn btn-outline-secondary">
                                        <i class="fas fa-times"></i> Сбросить фильтры
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Таблица договоров -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Список договоров</h5>
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <span class="badge bg-primary">Всего: [[${totalItems}]]</span>
                                <span class="badge bg-success ms-2">Активных: [[${activeCount}]]</span>
                            </div>
                            <select class="form-select form-select-sm w-auto" id="pageSize" onchange="changePageSize(this.value)">
                                <option value="10" th:selected="${size == 10}">10 строк</option>
                                <option value="25" th:selected="${size == 25}">25 строк</option>
                                <option value="50" th:selected="${size == 50}">50 строк</option>
                                <option value="100" th:selected="${size == 100}">100 строк</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>
                                            <a th:href="@{/contracts(page=0, size=${size}, sortBy='contractNumber', direction=${direction == 'asc' ? 'desc' : 'asc'})}">
                                                Номер договора
                                                <span th:if="${sortBy == 'contractNumber'}">
                                                    <i th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                                </span>
                                            </a>
                                        </th>
                                        <th>Клиент</th>
                                        <th>Тип страхования</th>
                                        <th>Статус</th>
                                        <th>
                                            <a th:href="@{/contracts(page=0, size=${size}, sortBy='startDate', direction=${direction == 'asc' ? 'desc' : 'asc'})}">
                                                Период действия
                                                <span th:if="${sortBy == 'startDate'}">
                                                    <i th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                                </span>
                                            </a>
                                        </th>
                                        <th>
                                            <a th:href="@{/contracts(page=0, size=${size}, sortBy='premiumAmount', direction=${direction == 'asc' ? 'desc' : 'asc'})}">
                                                Премия
                                                <span th:if="${sortBy == 'premiumAmount'}">
                                                    <i th:class="${direction == 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'}"></i>
                                                </span>
                                            </a>
                                        </th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="contract : ${contracts}">
                                        <td>
                                            <a th:href="@{/contracts/{id}(id=${contract.id})}" 
                                               class="text-decoration-none fw-bold">
                                                [[${contract.contractNumber}]]
                                            </a>
                                        </td>
                                        <td>
                                            <a th:href="@{/clients/{id}(id=${contract.client.id})}" 
                                               class="text-decoration-none">
                                                [[${contract.client.fullName}]]
                                            </a>
                                            <br>
                                            <small class="text-muted">[[${contract.client.phone}]]</small>
                                        </td>
                                        <td>
                                            <span class="badge" 
                                                  th:class="'bg-' + ${contract.insuranceType.code == 'CASCO' ? 'info' : 
                                                    (contract.insuranceType.code == 'OSAGO' ? 'primary' : 
                                                    (contract.insuranceType.code == 'LIFE' ? 'success' : 'warning'))}">
                                                [[${contract.insuranceType.name}]]
                                            </span>
                                        </td>
                                        <td>
                                            <span th:class="'badge bg-' + ${contract.status.code == 'ACTIVE' ? 'success' : 
                                                (contract.status.code == 'EXPIRED' ? 'warning' : 
                                                (contract.status.code == 'TERMINATED' ? 'danger' : 'secondary'))}">
                                                [[${contract.status.name}]]
                                            </span>
                                            <div th:if="${contract.endDate < T(java.time.LocalDate).now() && contract.status.code != 'EXPIRED'}"
                                                 class="text-danger small">
                                                <i class="fas fa-exclamation-triangle"></i> Истек
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <span th:text="${#dates.format(contract.startDate, 'dd.MM.yyyy')}"></span>
                                                -
                                                <span th:text="${#dates.format(contract.endDate, 'dd.MM.yyyy')}"></span>
                                            </div>
                                            <div class="progress" style="height: 5px; margin-top: 5px;">
                                                <div class="progress-bar" 
                                                     th:style="'width: ' + ${#dates.createNow().time - contract.startDate.toEpochDay() * 86400000} / 
                                                              (${contract.endDate.toEpochDay() - contract.startDate.toEpochDay()} * 86400000) * 100 + '%;'">
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="fw-bold" 
                                                  th:text="${#numbers.formatDecimal(contract.premiumAmount, 0, 'POINT', 2, 'COMMA')} + ' ₽'">
                                            </span>
                                            <br>
                                            <small class="text-muted">
                                                [[${#numbers.formatDecimal(contract.insuredAmount, 0, 'POINT', 2, 'COMMA')}]] ₽
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a th:href="@{/contracts/{id}(id=${contract.id})}" 
                                                   class="btn btn-info" title="Просмотр">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a th:href="@{/contracts/{id}/edit(id=${contract.id})}" 
                                                   class="btn btn-warning" title="Редактировать">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <button type="button" 
                                                        class="btn btn-danger" 
                                                        title="Удалить"
                                                        th:onclick="'confirmDelete(\'Вы уверены, что хотите удалить договор ' + ${contract.contractNumber} + '?\', \'/contracts/' + ${contract.id} + '/delete\')'">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(contracts)}">
                                        <td colspan="7" class="text-center py-5">
                                            <i class="fas fa-file-contract fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">Договоры не найдены</p>
                                            <a href="/contracts/new" class="btn btn-primary">
                                                <i class="fas fa-plus"></i> Оформить первый договор
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Пагинация -->
                        <div th:if="${totalPages > 1}" class="mt-3">
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                        <a class="page-link" th:href="@{/contracts(page=0, size=${size}, sortBy=${sortBy}, direction=${direction})}">
                                            <i class="fas fa-angle-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                        <a class="page-link" th:href="@{/contracts(page=${currentPage - 1}, size=${size}, sortBy=${sortBy}, direction=${direction})}">
                                            <i class="fas fa-angle-left"></i>
                                        </a>
                                    </li>
                                    
                                    <li th:each="i : ${#numbers.sequence(1, totalPages)}" 
                                        class="page-item" th:classappend="${currentPage == i - 1} ? 'active'">
                                        <a class="page-link" th:href="@{/contracts(page=${i - 1}, size=${size}, sortBy=${sortBy}, direction=${direction})}">
                                            [[${i}]]
                                        </a>
                                    </li>
                                    
                                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                                        <a class="page-link" th:href="@{/contracts(page=${currentPage + 1}, size=${size}, sortBy=${sortBy}, direction=${direction})}">
                                            <i class="fas fa-angle-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                                        <a class="page-link" th:href="@{/contracts(page=${totalPages - 1}, size=${size}, sortBy=${sortBy}, direction=${direction})}">
                                            <i class="fas fa-angle-double-right"></i>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                        
                        <div class="mt-2 text-center text-muted">
                            Показано [[${contracts.size()}]] из [[${totalItems}]] договоров
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div th:replace="fragments/footer :: footer"></div>
    <div th:replace="fragments/scripts :: scripts"></div>
    
    <script>
        function changePageSize(pageSize) {
            const url = new URL(window.location.href);
            url.searchParams.set('size', pageSize);
            url.searchParams.set('page', '0');
            window.location.href = url.toString();
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Автозаполнение дат для фильтрации
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (!startDateInput.value) {
                startDateInput.value = new Date(new Date().setMonth(new Date().getMonth() - 1))
                    .toISOString().split('T')[0];
            }
            
            if (!endDateInput.value) {
                endDateInput.value = new Date().toISOString().split('T')[0];
            }
            
            // Вычисление процента выполнения для каждого договора
            document.querySelectorAll('.progress-bar').forEach(bar => {
                const contractRow = bar.closest('tr');
                const startDate = new Date(contractRow.querySelector('.start-date').textContent);
                const endDate = new Date(contractRow.querySelector('.end-date').textContent);
                const today = new Date();
                
                const totalDays = (endDate - startDate) / (1000 * 60 * 60 * 24);
                const passedDays = (today - startDate) / (1000 * 60 * 60 * 24);
                const percentage = Math.min(100, Math.max(0, (passedDays / totalDays) * 100));
                
                bar.style.width = percentage + '%';
                
                if (percentage >= 100) {
                    bar.classList.add('bg-warning');
                } else if (percentage >= 75) {
                    bar.classList.add('bg-info');
                } else {
                    bar.classList.add('bg-success');
                }
            });
        });
    </script>
    
    <style>
        .progress {
            background-color: #e9ecef;
            border-radius: 3px;
        }
        
        .progress-bar {
            border-radius: 3px;
            transition: width 0.6s ease;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .badge {
            font-weight: 500;
        }
    </style>
</body>
</html>